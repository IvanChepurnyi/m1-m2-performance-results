<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-label/iron-label.html">
<link rel="import" href="../../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/chart-elements/chart-bar.html">
<link rel="import" href="../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">


<dom-module id="report-app">


  <style include="iron-flex iron-flex-alignment"></style>


  <template>
    <style>
      app-toolbar {
        background-color: #4285f4;
        color: #fff;
      }
      app-drawer {
        --app-drawer-scrim-background: rgba(0, 0, 100, 0.8);
        --app-drawer-content-container: {
          background-color: #B0BEC5;
        };

        --app-drawer-width: 400px;

      }


      .wide {
        width: 100%;
      }

      .wide {
        padding: 15px;
      }

      .wide .title {
        margin-bottom: 15px;
      }

      .wide a {
        color: #1a237e;
      }

      .wide iron-icon {
        color: #ffffff;
        margin-right: 20px;
        height: 40px;
        width: 40px;
      }

      .wide paper-checkbox {
        margin-left: 10px;
        width: 160px;
      }

      .wide .small {
        font-size: 12px;
      }
    </style>
    <iron-ajax auto
               url="[[url]]"
               handle-as="json"
               on-response="fillData"></iron-ajax>

    <app-toolbar>
      <paper-icon-button icon="menu" onclick="appDrawer.toggle()"></paper-icon-button>
      <div class="title">[[heading]]</div>
    </app-toolbar>

    <paper-card class="wide" heading="Detailed Reports">
      <template is="dom-repeat" items="{{filteredRecords}}" as="report">
        <a href="[[prefix]][[report.path]]"><paper-item><iron-icon icon="icons:dot" style="background-color:[[report.color]]"></iron-icon> [[report.fullLabel]]</paper-item></a>
      </template>
    </paper-card>

    <template is="dom-repeat" items="{{globalReports}}" as="report">
      <paper-card class="wide" heading="{{report.label}}">
        <chart-bar class="wide" data="{{report.data}}" options="{{report.options}}"></chart-bar>
        <template is="dom-repeat" items="{{report.abbreviation}}" as="abbreviation">
          <div class="small">{{abbreviation}}</div>
        </template>
      </paper-card>
    </template>

    <paper-card class="wide">
      <h4>Page based report: [[currentPage.label]]
      <paper-menu-button>
        <paper-icon-button icon="menu" class="dropdown-trigger"></paper-icon-button>
        <paper-menu class="dropdown-content" attr-for-selected="value" selected="{{currentPageCode}}" on-iron-select="_updatePage">
          <template is="dom-repeat" items="{{pages}}" as="page">
            <paper-item value="[[page.code]]">[[page.label]]</paper-item>
          </template>
        </paper-menu>
      </paper-menu-button></h4>
    </paper-card>

    <template is="dom-repeat" items="{{pageReports}}" as="report">
      <paper-card class="wide" heading="{{report.label}}">
        <chart-bar class="wide" data="{{report.data}}" options="{{report.options}}"></chart-bar>
        <template is="dom-repeat" items="{{report.abbreviation}}" as="abbreviation">
          <div class="small">{{abbreviation}}</div>
        </template>
      </paper-card>
    </template>

    <app-drawer slidable id="appDrawer" >
        <template is="dom-repeat" items="{{filters}}" as="filter">
          <template is="dom-if" if="{{filter.multiple}}">
            <paper-card class="wide">
              <div class="title">[[filter.label]]</div>
              <div class="layout horizontal">
                <template is="dom-repeat" items="{{filter.selections}}" as="option">
                  <paper-checkbox value="[[option]]" checked="{{option.checked}}" on-change="_filterChange">[[option.option]]</paper-checkbox>
                </template>
              </div>
            </paper-card>
          </template>
        </template>

      <template is="dom-repeat" items="{{filters}}" as="filter">
        <template is="dom-if" if="{{!filter.multiple}}">
          <paper-card class="wide">
            <paper-dropdown-menu label="[[filter.label]]">
              <paper-listbox class="dropdown-content" attr-for-selected="value" selected="{{filter.selection}}" on-iron-select="_filterChange">
                <template is="dom-repeat" items="{{filter.options}}" as="option">
                  <paper-item value="[[option]]">[[option]]</paper-item>
                </template>
              </paper-listbox>
            </paper-dropdown-menu>
          </paper-card>
        </template>
      </template>
    </app-drawer>


  </template>
  <script>
    Polymer({
      is: 'report-app',
      behaviors: [
        Polymer.IronResizableBehavior
      ],

      listeners: {
        'iron-resize': '_onIronResize'
      },

      properties: {
        heading: String,
        url: String,
        prefix: String,
        globalReports: {
          type: Array,
          notify: true,
          value: []
        },
        pageReports: {
          type: Array,
          notify: true,
          value: []
        },
        currentPage: {
          type: Object,
          notify: true,
          value: {
            label: "None",
            code: ""
          }
        },
        currentPageCode: String,
        pages: {
          type: Array,
          notify: true,
          value: []
        },
        reportData: {
          type: Object,
          notify: true,
          value: {}
        },
        filteredRecords: {
          type: Array,
          notify: true,
          value: []
        },
        filters: {
          type: Array,
          notify: true,
          value: [],
          observer: '_filterChange'
        },
        minDesktopScreenWidth: Number,
        screenWidth: Number,
        viewStyle: {
          type: String,
          value: 'desktop'
        }
      },
      attached: function() {
        this.async(this.notifyResize, 1);
      },
      get parent() {
        if (this.parentNode.nodeType === Node.DOCUMENT_FRAGMENT_NODE) {
          return this.parentNode.host;
        }
        return this.parentNode;
      },
      _onIronResize: function() {
        this.screenWidth = Math.floor(this.parent.offsetWidth);
        this._validateScreen();
        this._updateGlobalReports();
        this._updatePage();
      },

      _validateScreen: function () {
        if (this.screenWidth < this.minDesktopScreenWidth && this.viewStyle == 'desktop') {
          this.set('viewStyle', 'mobile');
        } else if (this.screenWidth >= this.minDesktopScreenWidth && this.viewStyle == 'mobile') {
          this.set('viewStyle', 'desktop');
        }
      },

      fillData: function (data) {
        var dataResults = data.target.lastResponse;

        this.updateFilters(dataResults);
        this.set('reportData', dataResults);
        this._validateScreen();
        this._filterChange();
        this._updatePages();
      },

      updateFilters: function (dataResults) {
        var filters = [];

        for (var filterCode in dataResults.filters) {
          var filter = dataResults.filters[filterCode];
          filter.code = filterCode;
          if (filter.multiple) {
            filter.selections = [];

            for (var i = 0, l = filter.options.length; i < l; i++) {
              filter.selections.push({
                option: filter.options[i],
                checked: (filter.selection.indexOf(filter.options[i]) !== -1)
              });
            }
          }

          filters.push(filter);
        }

        this.set('filters', filters);
      },

      _updateReports: function () {
        if (this.reportData.aggregateReport) {
          this._updateGlobalReports();
        }
      },

      _updatePage: function () {
        for (var pageIndex in this.pages) {
          if (this.pages[pageIndex].code == this.currentPageCode) {
            this.set('currentPage', this.pages[pageIndex]);
          }
        }

        if (this.reportData.pageReport) {
          this._updatePageReports();
        }
      },

      _validateAxis: function (axis) {
        var result = {
          axis: [],
          abbreviation: []
        };

        for (var axisIndex in axis) {
          if (this.viewStyle == 'mobile') {
            var abbreviation = '#' + (parseInt(axisIndex) + 1);
            result.axis.push(abbreviation);
            result.abbreviation.push(abbreviation + ' ' + axis[axisIndex]);
            continue;
          }
          result.axis.push(axis[axisIndex]);
        }

        return result;
      },

      _updateGlobalReports: function () {
        var reports = [];

        for (var reportIndex in this.reportData.aggregateReport) {
          var reportConfig = this.reportData.aggregateReport[reportIndex];
          var axis = this._validateAxis(reportConfig.axis);
          var report = {
            data: this._prepareChartData(
                    axis.axis,
                    this.filteredRecords,
                    'aggregateReport.' + reportConfig.dataCode
            ),
            label: reportConfig.label,
            abbreviation: axis.abbreviation,
            options: {
              legend: {
                display: this.viewStyle != 'mobile'
              }
            }
          };

          reports.push(report);
        }

        this.set('globalReports', reports);
      },

      _updatePages: function () {
        var pages = [];
        for (var pageCode in this.reportData.pages) {
          pages.push({
            code: pageCode,
            label: this.reportData.pages[pageCode]
          })
        }

        this.set('pages', pages);
        if (pages.length) {
          this.set('currentPageCode', pages[0].code)
          this._updatePage();
        }
      },

      _updatePageReports: function () {
        var reports = [];

        for (var reportIndex in this.reportData.pageReport) {
          var reportConfig = this.reportData.pageReport[reportIndex];
          var axis = this._validateAxis(reportConfig.axis);
          var report = {
            data: this._prepareChartData(
                    axis.axis,
                    this.filteredRecords,
                    'pageReport.' + reportConfig.dataCode + '.' + this.currentPage.code
            ),
            label: reportConfig.label.replace("#Page", this.currentPage.label),
            abbreviation: axis.abbreviation,
            options: {
              legend: {
                display: this.viewStyle != 'mobile'
              }
            }
          };
          reports.push(report);
        }

        this.set('pageReports', reports);
      },

      _filterChange: function () {
        var filteredReports = [];

        var existingLegends = [];
        var fullLabels = false;
        var uniqueFilters = [];

        var additionalInfo={data_set: 'Set: ', image_cache: 'Image: ', php: 'PHP: '};

        for (var reportIndex in this.reportData.reports) {
          var report = this.reportData.reports[reportIndex];
          if (!this._validateFilterSelected(report.filter)) {
            continue;
          }

          filteredReports.push(report);
          report.fullLegend = report.legend;
          report.fullLabel = report.legend;

          if (existingLegends.indexOf(report.legend)) {
            fullLabels = true;
          }

          for (var filter in additionalInfo) {
            if (!uniqueFilters[report.legend]) {
              uniqueFilters[report.legend] = {};
              uniqueFilters[report.legend][filter] = 0;
            }

            uniqueFilters[report.legend][filter] += 1;
          }

          existingLegends.push(report.legend);
        }

        for (var reportIndex in filteredReports) {
          var report = filteredReports[reportIndex];
          var additionalLabels = [];
          var additionalLegends = [];

          for (var filter in additionalInfo) {
            additionalLabels.push(additionalInfo[filter] + report.filter[filter]);
            if (uniqueFilters[report.legend][filter] > 0) {
              additionalLegends.push(report.filter[filter])
            }
          }

          report.fullLabel += ' (' + additionalLabels.join(', ') + ')';
          if (additionalLegends.length) {
            report.fullLegend += ' (' + additionalLegends.join(', ') + ')';
          }
        }

        this.set('filteredRecords', filteredReports);
        this._updateReports();
        this._updatePage();
      },
      _validateFilterSelected: function (availableFilters) {
        for (var filterIndex in this.filters) {
          if (!availableFilters[this.filters[filterIndex].code]) {
            return false;
          }

          if (this.filters[filterIndex].multiple) {
            var found = false;
            var selections = this.filters[filterIndex].selections;
            for (var selectionIndex in selections) {
              if (availableFilters[this.filters[filterIndex].code] == selections[selectionIndex].option
                      && selections[selectionIndex].checked) {
                found = true;
              }
            }

            if (!found) {
              return false;
            }
          } else if(this.filters[filterIndex].selection != availableFilters[this.filters[filterIndex].code]) {
            return false;
          }
        }

        return true;
      },
      _prepareChartData: function (axis, records, propertyPath) {
        var data = {
          labels: axis,
          datasets: []
        };

        records = records.sort(function (a, b) {
          return a.position - b.position;
        });


        for (var reportIndex in records) {
          var report = records[reportIndex];
          var legend = report.fullLegend;

          data.datasets.push({
            label: legend,
            backgroundColor: report.color,
            data: this.valueFetch(report, propertyPath)
          });
        }

        return data;
      },
      valueFetch: function (obj, path) {
        var properties = path.split('.');

        for (var propertyIndex in properties) {
          if (obj[properties[propertyIndex]] === undefined) {
            return null;
          }

          obj = obj[properties[propertyIndex]]
        }

        return obj;
      }
    })
  </script>
</dom-module>
